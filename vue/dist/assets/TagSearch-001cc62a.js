import{ap as J,ao as X,c4 as K,bT as W,d as Y,v as Z,aX as ee,U as E,r as $,V as ae,ac as te,bv as se,bw as ne,o as c,l as m,J as b,s as S,q as T,c as C,n as d,S as oe,y as B,m as A,B as I,t as _,C as M,I as re,c8 as le,z as N,b5 as ie,c9 as ue,bs as P,T as D,Q as ce}from"./index-edca4075.js";import{I as de,_ as pe}from"./index-74c0ac6b.js";import"./index-4aeb0932.js";import{c as V,e as ge,f as me,M as ve,r as fe,u as _e}from"./db-0ad5acd9.js";import{b as ye}from"./_baseIteratee-8e08e621.js";import{B as z}from"./button-8244f7e4.js";function he(s,n,t,r){for(var u=-1,a=s==null?0:s.length;++u<a;){var o=s[u];n(r,o,t(o),s)}return r}function be(s){return function(n,t,r){for(var u=-1,a=Object(n),o=r(n),v=o.length;v--;){var k=o[s?v:++u];if(t(a[k],k,a)===!1)break}return n}}var ke=be();const Ce=ke;function Ie(s,n){return s&&Ce(s,n,J)}function xe(s,n){return function(t,r){if(t==null)return t;if(!X(t))return s(t,r);for(var u=t.length,a=n?u:-1,o=Object(t);(n?a--:++a<u)&&r(o[a],a,o)!==!1;);return t}}var we=xe(Ie);const $e=we;function Se(s,n,t,r){return $e(s,function(u,a,o){n(r,u,t(u),o)}),r}function Te(s,n){return function(t,r){var u=K(t)?he:Se,a=n?n():{};return u(t,s,ye(r),a)}}var Be=Object.prototype,Ae=Be.hasOwnProperty,Oe=Te(function(s,n,t){Ae.call(s,t)?s[t].push(n):W(s,t,[n])});const Ee=Oe,De={class:"container"},Fe={class:"search-bar"},Me={key:0,class:"generate-idx-hint"},Ne={class:"list-container"},Pe={class:"cat-name"},Ve=["onClick"],ze=["onClickCapture"],Ue=Y({__name:"TagSearch",props:{tabIdx:null,paneIdx:null},setup(s){const n=s,t=Z(),r=ee(),u=E(()=>!r.isIdle),a=$(),o=$(new Set),v=E(()=>a.value?a.value.tags.slice().sort((e,l)=>l.count-e.count):[]),k=["custom","Model","lora","pos","size","Postprocess upscaler","Postprocess upscale by","Sampler"].reduce((e,l,g)=>(e[l]=g,e),{}),U=E(()=>Object.entries(Ee(v.value,e=>e.type)).sort((e,l)=>k[e[0]]-k[l[0]])),q=ae();te(async()=>{a.value=await V(),a.value.img_count&&a.value.expired&&F()});const F=se(()=>r.pushAction(async()=>(await _e(),a.value=await V(),a.value)).res),G=()=>{t.openTagSearchMatchedImageGridInRight(n.tabIdx,q,Array.from(o.value))};ne("return-to-iib",async()=>{const e=await r.pushAction(ge).res;a.value.expired=e.expired});const O=(e,l=!1)=>(l?`[${e.type}] `:"")+(e.display_name?`${e.display_name} : ${e.name}`:e.name),x=$(!1),y=$(""),L=async()=>{var l,g,f;if(!y.value){x.value=!1;return}const e=await r.pushAction(()=>me({tag_name:y.value})).res;e.type!=="custom"&&P.error(D("existInOtherType")),(l=a.value)!=null&&l.tags.find(h=>h.id===e.id)?P.error(D("alreadyExists")):((g=a.value)==null||g.tags.push(e),(f=t.conf)==null||f.all_custom_tags.push(e)),y.value="",x.value=!1},j=e=>{ve.confirm({title:D("confirmDelete"),async onOk(){var g,f,h,w;await fe({tag_id:e});const l=((g=a.value)==null?void 0:g.tags.findIndex(i=>i.id===e))??-1;(f=a.value)==null||f.tags.splice(l,1),(w=t.conf)==null||w.all_custom_tags.splice((h=t.conf)==null?void 0:h.all_custom_tags.findIndex(i=>i.id===e),1)}})};return(e,l)=>{const g=z,f=de,h=z,w=pe;return c(),m("div",De,[b("",!0),a.value?(c(),m(S,{key:1},[T("div",null,[T("div",Fe,[C(d(oe),{conv:{value:i=>i.id,text:O,optionText:i=>O(i,!0)},mode:"multiple",style:{width:"100%"},options:d(v),value:Array.from(o.value),disabled:!d(v).length,placeholder:"Select tags to match images","onUpdate:value":l[0]||(l[0]=i=>o.value=new Set(i))},null,8,["conv","options","value","disabled"]),a.value.expired||!a.value.img_count?(c(),B(g,{key:0,onClick:d(F),loading:!d(r).isIdle,type:"primary"},{default:A(()=>[I(_(a.value.img_count===0?e.$t("generateIndexHint"):e.$t("UpdateIndex")),1)]),_:1},8,["onClick","loading"])):(c(),B(g,{key:1,type:"primary",onClick:G,loading:!d(r).isIdle,disabled:!o.value.size},{default:A(()=>[I(_(e.$t("search")),1)]),_:1},8,["loading","disabled"]))])]),d(v).filter(i=>i.type!=="custom").length?b("",!0):(c(),m("p",Me,_(e.$t("needGenerateIdx")),1)),T("div",Ne,[(c(!0),m(S,null,M(d(U),([i,Q])=>(c(),m("ul",{class:"tag-list",key:i},[T("h3",Pe,_(e.$t(i)),1),(c(!0),m(S,null,M(Q,(p,R)=>(c(),m("li",{key:p.id,class:re(["tag",{selected:o.value.has(p.id)}]),onClick:H=>o.value.has(p.id)?o.value.delete(p.id):o.value.add(p.id)},[o.value.has(p.id)?(c(),B(d(le),{key:0})):b("",!0),I(" "+_(O(p))+" ",1),i==="custom"&&R!==0?(c(),m("span",{key:1,class:"remove",onClickCapture:N(H=>j(p.id),["stop"])},[C(d(ie))],40,ze)):b("",!0)],10,Ve))),128)),i==="custom"?(c(),m("li",{key:0,class:"tag",onClick:l[2]||(l[2]=p=>x.value=!0)},[x.value?(c(),B(w,{key:0,compact:""},{default:A(()=>[C(f,{value:y.value,"onUpdate:value":l[1]||(l[1]=p=>y.value=p),style:{width:"128px"},loading:d(u),"allow-clear":"",size:"small"},null,8,["value","loading"]),C(h,{size:"small",type:"primary",onClickCapture:N(L,["stop"]),loading:d(u)},{default:A(()=>[I(_(y.value?e.$t("submit"):e.$t("cancel")),1)]),_:1},8,["onClickCapture","loading"])]),_:1})):(c(),m(S,{key:1},[C(d(ue)),I(" "+_(e.$t("add")),1)],64))])):b("",!0)]))),128))])],64)):b("",!0)])}}});const He=ce(Ue,[["__scopeId","data-v-2a184aeb"]]);export{He as default};
