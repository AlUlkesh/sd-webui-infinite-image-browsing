import{at as K,as as R,b$ as Y,bO as W,d as X,z as Z,B as ee,C as ae,a1 as A,r as w,a2 as te,v as se,o as u,l as g,N as y,s as $,q as x,c as k,n as m,Y as ne,K as B,m as O,I as C,t as f,J as M,O as oe,c3 as re,Q as V,b6 as le,c4 as ie,bo as z,L as N,V as ue}from"./index-a52af617.js";import{I as ce,_ as de}from"./index-3d756f88.js";import"./index-17b18069.js";import{c as D,u as pe,e as ge,M as me,r as ve}from"./db-86011ee4.js";import{b as fe}from"./_baseIteratee-4a6b4f10.js";import{B as E}from"./button-4d75a231.js";function _e(s,n,t,l){for(var i=-1,a=s==null?0:s.length;++i<a;){var o=s[i];n(l,o,t(o),s)}return l}function he(s){return function(n,t,l){for(var i=-1,a=Object(n),o=l(n),v=o.length;v--;){var b=o[s?v:++i];if(t(a[b],b,a)===!1)break}return n}}var ye=he();const be=ye;function ke(s,n){return s&&be(s,n,K)}function Ce(s,n){return function(t,l){if(t==null)return t;if(!R(t))return s(t,l);for(var i=t.length,a=n?i:-1,o=Object(t);(n?a--:++a<i)&&l(o[a],a,o)!==!1;);return t}}var Ie=Ce(ke);const we=Ie;function $e(s,n,t,l){return we(s,function(i,a,o){n(l,i,t(i),o)}),l}function xe(s,n){return function(t,l){var i=Y(t)?_e:$e,a=n?n():{};return i(t,s,fe(l),a)}}var Be=Object.prototype,Oe=Be.hasOwnProperty,Se=xe(function(s,n,t){Oe.call(s,t)?s[t].push(n):W(s,t,[n])});const Te=Se,Ae={class:"container"},Ne={class:"search-bar"},Fe={key:0,class:"generate-idx-hint"},Me={class:"list-container"},Ve={class:"cat-name"},ze=["onClick"],De=["onClickCapture"],Ee=X({__name:"TagSearch",props:{tabIdx:null,paneIdx:null},setup(s){const n=s,t=Z(),l=ee(new ae(-1,0,-1,"throw")),i=A(()=>!l.isIdle),a=w(),o=w(new Set),v=A(()=>a.value?a.value.tags.slice().sort((e,r)=>r.count-e.count):[]),b=["custom","Model","lora","pos","size","Sampler"].reduce((e,r,p)=>(e[r]=p,e),{}),q=A(()=>Object.entries(Te(v.value,e=>e.type)).sort((e,r)=>b[e[0]]-b[r[0]])),P=te();se(async()=>{a.value=await D(),a.value.img_count&&a.value.expired&&F()});const F=async()=>{l.pushAction(async()=>{await pe(),a.value=await D()})},U=()=>{t.openTagSearchMatchedImageGridInRight(n.tabIdx,P,Array.from(o.value))},S=(e,r=!1)=>(r?`[${e.type}] `:"")+(e.display_name?`${e.display_name} : ${e.name}`:e.name),I=w(!1),_=w(""),G=async()=>{var r,p;if(!_.value){I.value=!1;return}const e=await l.pushAction(()=>ge({tag_name:_.value})).res;e.type!=="custom"&&z.error(N("existInOtherType")),(r=a.value)!=null&&r.tags.find(h=>h.id===e.id)?z.error(N("alreadyExists")):(p=a.value)==null||p.tags.push(e),_.value="",I.value=!1},L=e=>{me.confirm({title:N("confirmDelete"),async onOk(){var p,h;await ve({tag_id:e});const r=((p=a.value)==null?void 0:p.tags.findIndex(T=>T.id===e))??-1;(h=a.value)==null||h.tags.splice(r,1)}})};return(e,r)=>{const p=E,h=ce,T=E,j=de;return u(),g("div",Ae,[y("",!0),a.value?(u(),g($,{key:1},[x("div",null,[x("div",Ne,[k(m(ne),{conv:{value:c=>c.id,text:S,optionText:c=>S(c,!0)},mode:"multiple",style:{width:"100%"},options:m(v),value:Array.from(o.value),disabled:!m(v).length,placeholder:"Select tags to match images","onUpdate:value":r[0]||(r[0]=c=>o.value=new Set(c))},null,8,["conv","options","value","disabled"]),a.value.expired||!a.value.img_count?(u(),B(p,{key:0,onClick:F,loading:!l.isIdle,type:"primary"},{default:O(()=>[C(f(a.value.img_count===0?e.$t("generateIndexHint"):e.$t("UpdateIndex")),1)]),_:1},8,["loading"])):(u(),B(p,{key:1,type:"primary",onClick:U,loading:!l.isIdle,disabled:!o.value.size},{default:O(()=>[C(f(e.$t("search")),1)]),_:1},8,["loading","disabled"]))])]),m(v).filter(c=>c.type!=="custom").length?y("",!0):(u(),g("p",Fe,f(e.$t("needGenerateIdx")),1)),x("div",Me,[(u(!0),g($,null,M(m(q),([c,Q])=>(u(),g("ul",{class:"tag-list",key:c},[x("h3",Ve,f(e.$t(c)),1),(u(!0),g($,null,M(Q,(d,H)=>(u(),g("li",{key:d.id,class:oe(["tag",{selected:o.value.has(d.id)}]),onClick:J=>o.value.has(d.id)?o.value.delete(d.id):o.value.add(d.id)},[o.value.has(d.id)?(u(),B(m(re),{key:0})):y("",!0),C(" "+f(S(d))+" ",1),c==="custom"&&H!==0?(u(),g("span",{key:1,class:"remove",onClickCapture:V(J=>L(d.id),["stop"])},[k(m(le))],40,De)):y("",!0)],10,ze))),128)),c==="custom"?(u(),g("li",{key:0,class:"tag",onClick:r[2]||(r[2]=d=>I.value=!0)},[I.value?(u(),B(j,{key:0,compact:""},{default:O(()=>[k(h,{value:_.value,"onUpdate:value":r[1]||(r[1]=d=>_.value=d),style:{width:"128px"},loading:m(i),"allow-clear":"",size:"small"},null,8,["value","loading"]),k(T,{size:"small",type:"primary",onClickCapture:V(G,["stop"]),loading:m(i)},{default:O(()=>[C(f(_.value?e.$t("submit"):e.$t("cancel")),1)]),_:1},8,["onClickCapture","loading"])]),_:1})):(u(),g($,{key:1},[k(m(ie)),C(" "+f(e.$t("add")),1)],64))])):y("",!0)]))),128))])],64)):y("",!0)])}}});const Qe=ue(Ee,[["__scopeId","data-v-f84fa742"]]);export{Qe as default};
