import{at as J,as as K,b$ as W,bO as Z,d as X,z as Y,C as ee,E as ae,B as N,r as $,a2 as te,v as se,o as c,l as m,O as b,s as B,q as O,c as C,n as g,Z as ne,J as S,m as T,K as I,t as _,L as M,Q as oe,c3 as re,R as P,b6 as le,c4 as ie,bo as z,N as E,W as ue}from"./index-f85c2dbf.js";import{I as ce,_ as de}from"./index-41185077.js";import"./index-1d410437.js";import{c as D,u as pe,e as me,M as ge,r as ve}from"./db-9d80b1a6.js";import{b as fe}from"./_baseIteratee-da3485ca.js";import{B as V}from"./button-3c6fce50.js";function _e(s,n,t,l){for(var u=-1,a=s==null?0:s.length;++u<a;){var o=s[u];n(l,o,t(o),s)}return l}function he(s){return function(n,t,l){for(var u=-1,a=Object(n),o=l(n),v=o.length;v--;){var k=o[s?v:++u];if(t(a[k],k,a)===!1)break}return n}}var ye=he();const be=ye;function ke(s,n){return s&&be(s,n,J)}function Ce(s,n){return function(t,l){if(t==null)return t;if(!K(t))return s(t,l);for(var u=t.length,a=n?u:-1,o=Object(t);(n?a--:++a<u)&&l(o[a],a,o)!==!1;);return t}}var Ie=Ce(ke);const we=Ie;function xe(s,n,t,l){return we(s,function(u,a,o){n(l,u,t(u),o)}),l}function $e(s,n){return function(t,l){var u=W(t)?_e:xe,a=n?n():{};return u(t,s,fe(l),a)}}var Be=Object.prototype,Oe=Be.hasOwnProperty,Se=$e(function(s,n,t){Oe.call(s,t)?s[t].push(n):Z(s,t,[n])});const Te=Se,Ae={class:"container"},Ne={class:"search-bar"},Ee={key:0,class:"generate-idx-hint"},Fe={class:"list-container"},Me={class:"cat-name"},Pe=["onClick"],ze=["onClickCapture"],De=X({__name:"TagSearch",props:{tabIdx:null,paneIdx:null},setup(s){const n=s,t=Y(),l=ee(new ae(-1,0,-1,"throw")),u=N(()=>!l.isIdle),a=$(),o=$(new Set),v=N(()=>a.value?a.value.tags.slice().sort((e,r)=>r.count-e.count):[]),k=["custom","Model","lora","pos","size","Postprocess upscaler","Postprocess upscale by","Sampler"].reduce((e,r,p)=>(e[r]=p,e),{}),q=N(()=>Object.entries(Te(v.value,e=>e.type)).sort((e,r)=>k[e[0]]-k[r[0]])),U=te();se(async()=>{a.value=await D(),a.value.img_count&&a.value.expired&&F()});const F=async()=>{l.pushAction(async()=>{await pe(),a.value=await D()})},G=()=>{t.openTagSearchMatchedImageGridInRight(n.tabIdx,U,Array.from(o.value))},A=(e,r=!1)=>(r?`[${e.type}] `:"")+(e.display_name?`${e.display_name} : ${e.name}`:e.name),w=$(!1),h=$(""),L=async()=>{var r,p,f;if(!h.value){w.value=!1;return}const e=await l.pushAction(()=>me({tag_name:h.value})).res;e.type!=="custom"&&z.error(E("existInOtherType")),(r=a.value)!=null&&r.tags.find(y=>y.id===e.id)?z.error(E("alreadyExists")):((p=a.value)==null||p.tags.push(e),(f=t.conf)==null||f.all_custom_tags.push(e)),h.value="",w.value=!1},j=e=>{ge.confirm({title:E("confirmDelete"),async onOk(){var p,f,y,x;await ve({tag_id:e});const r=((p=a.value)==null?void 0:p.tags.findIndex(i=>i.id===e))??-1;(f=a.value)==null||f.tags.splice(r,1),(x=t.conf)==null||x.all_custom_tags.splice((y=t.conf)==null?void 0:y.all_custom_tags.findIndex(i=>i.id===e),1)}})};return(e,r)=>{const p=V,f=ce,y=V,x=de;return c(),m("div",Ae,[b("",!0),a.value?(c(),m(B,{key:1},[O("div",null,[O("div",Ne,[C(g(ne),{conv:{value:i=>i.id,text:A,optionText:i=>A(i,!0)},mode:"multiple",style:{width:"100%"},options:g(v),value:Array.from(o.value),disabled:!g(v).length,placeholder:"Select tags to match images","onUpdate:value":r[0]||(r[0]=i=>o.value=new Set(i))},null,8,["conv","options","value","disabled"]),a.value.expired||!a.value.img_count?(c(),S(p,{key:0,onClick:F,loading:!l.isIdle,type:"primary"},{default:T(()=>[I(_(a.value.img_count===0?e.$t("generateIndexHint"):e.$t("UpdateIndex")),1)]),_:1},8,["loading"])):(c(),S(p,{key:1,type:"primary",onClick:G,loading:!l.isIdle,disabled:!o.value.size},{default:T(()=>[I(_(e.$t("search")),1)]),_:1},8,["loading","disabled"]))])]),g(v).filter(i=>i.type!=="custom").length?b("",!0):(c(),m("p",Ee,_(e.$t("needGenerateIdx")),1)),O("div",Fe,[(c(!0),m(B,null,M(g(q),([i,Q])=>(c(),m("ul",{class:"tag-list",key:i},[O("h3",Me,_(e.$t(i)),1),(c(!0),m(B,null,M(Q,(d,R)=>(c(),m("li",{key:d.id,class:oe(["tag",{selected:o.value.has(d.id)}]),onClick:H=>o.value.has(d.id)?o.value.delete(d.id):o.value.add(d.id)},[o.value.has(d.id)?(c(),S(g(re),{key:0})):b("",!0),I(" "+_(A(d))+" ",1),i==="custom"&&R!==0?(c(),m("span",{key:1,class:"remove",onClickCapture:P(H=>j(d.id),["stop"])},[C(g(le))],40,ze)):b("",!0)],10,Pe))),128)),i==="custom"?(c(),m("li",{key:0,class:"tag",onClick:r[2]||(r[2]=d=>w.value=!0)},[w.value?(c(),S(x,{key:0,compact:""},{default:T(()=>[C(f,{value:h.value,"onUpdate:value":r[1]||(r[1]=d=>h.value=d),style:{width:"128px"},loading:g(u),"allow-clear":"",size:"small"},null,8,["value","loading"]),C(y,{size:"small",type:"primary",onClickCapture:P(L,["stop"]),loading:g(u)},{default:T(()=>[I(_(h.value?e.$t("submit"):e.$t("cancel")),1)]),_:1},8,["onClickCapture","loading"])]),_:1})):(c(),m(B,{key:1},[C(g(ie)),I(" "+_(e.$t("add")),1)],64))])):b("",!0)]))),128))])],64)):b("",!0)])}}});const Qe=ue(De,[["__scopeId","data-v-eea01c01"]]);export{Qe as default};
