import{ap as Y,ao as Z,a$ as ee,b0 as ae,d as te,v as se,b1 as ne,U as x,r as B,V as oe,ac as le,b2 as re,b3 as ie,o as c,l as v,J as C,s as S,q as f,t as m,c as y,n as l,S as D,y as A,m as O,B as I,C as P,I as ue,b4 as de,z as V,b5 as ce,b6 as pe,b7 as q,T as F,Q as ge}from"./index-099ba529.js";import{I as ve}from"./index-f683e8c5.js";import"./index-128adff6.js";import{a as z,b as me,c as _e,M as fe,r as he,u as ye}from"./db-7a76cada.js";import{b as be}from"./_baseIteratee-bc1a15f5.js";import{_ as ke}from"./index-e7aa8628.js";import{B as G}from"./button-a470f2db.js";function Ce(o,r,n,i){for(var d=-1,a=o==null?0:o.length;++d<a;){var t=o[d];r(i,t,n(t),o)}return i}function $e(o){return function(r,n,i){for(var d=-1,a=Object(r),t=i(r),p=t.length;p--;){var $=t[o?p:++d];if(n(a[$],$,a)===!1)break}return r}}var Ie=$e();const we=Ie;function Te(o,r){return o&&we(o,r,Y)}function xe(o,r){return function(n,i){if(n==null)return n;if(!Z(n))return o(n,i);for(var d=n.length,a=r?d:-1,t=Object(n);(r?a--:++a<d)&&i(t[a],a,t)!==!1;);return n}}var Be=xe(Te);const Se=Be;function Ae(o,r,n,i){return Se(o,function(d,a,t){r(i,d,n(d),t)}),i}function Oe(o,r){return function(n,i){var d=ee(n)?Ce:Ae,a=r?r():{};return d(n,o,be(i),a)}}var Me=Object.prototype,Ee=Me.hasOwnProperty,Ue=Oe(function(o,r,n){Ee.call(o,n)?o[n].push(r):ae(o,n,[r])});const De=Ue,Fe={class:"container"},Ne={class:"search-bar"},Pe={class:"form-name"},Ve={class:"search-bar"},qe={class:"form-name"},ze={class:"search-bar"},Ge={class:"form-name"},Le={key:0,class:"generate-idx-hint"},je={class:"list-container"},Qe={class:"cat-name"},Re=["onClick"],He=["onClickCapture"],Je=te({__name:"TagSearch",props:{tabIdx:null,paneIdx:null},setup(o){const r=o,n=se(),i=ne(),d=x(()=>!i.isIdle),a=B(),t=B({and_tags:[],or_tags:[],not_tags:[]}),p=x(()=>a.value?a.value.tags.slice().sort((e,s)=>s.count-e.count):[]),$=["custom","Model","lora","pos","size","Postprocess upscaler","Postprocess upscale by","Sampler"].reduce((e,s,g)=>(e[s]=g,e),{}),L=x(()=>Object.entries(De(p.value,e=>e.type)).sort((e,s)=>$[e[0]]-$[s[0]])),j=oe();le(async()=>{a.value=await z(),a.value.img_count&&a.value.expired&&N()});const N=re(()=>i.pushAction(async()=>(await ye(),a.value=await z(),a.value)).res),Q=()=>{n.openTagSearchMatchedImageGridInRight(r.tabIdx,j,t.value)};ie("return-to-iib",async()=>{const e=await i.pushAction(me).res;a.value.expired=e.expired});const M=(e,s=!1)=>(s?`[${e.type}] `:"")+(e.display_name?`${e.display_name} : ${e.name}`:e.name),w=B(!1),b=B(""),R=async()=>{var s,g,h;if(!b.value){w.value=!1;return}const e=await i.pushAction(()=>_e({tag_name:b.value})).res;e.type!=="custom"&&q.error(F("existInOtherType")),(s=a.value)!=null&&s.tags.find(k=>k.id===e.id)?q.error(F("alreadyExists")):((g=a.value)==null||g.tags.push(e),(h=n.conf)==null||h.all_custom_tags.push(e)),b.value="",w.value=!1},H=e=>{fe.confirm({title:F("confirmDelete"),async onOk(){var g,h,k,T;await he({tag_id:e});const s=((g=a.value)==null?void 0:g.tags.findIndex(u=>u.id===e))??-1;(h=a.value)==null||h.tags.splice(s,1),(T=n.conf)==null||T.all_custom_tags.splice((k=n.conf)==null?void 0:k.all_custom_tags.findIndex(u=>u.id===e),1)}})},E=x(()=>new Set([t.value.and_tags,t.value.or_tags,t.value.not_tags].flat())),J=e=>{E.value.has(e.id)?(t.value.and_tags=t.value.and_tags.filter(s=>s!==e.id),t.value.or_tags=t.value.or_tags.filter(s=>s!==e.id),t.value.not_tags=t.value.not_tags.filter(s=>s!==e.id)):t.value.and_tags.push(e.id)},U={value:e=>e.id,text:M,optionText:e=>M(e,!0)};return(e,s)=>{const g=G,h=ve,k=G,T=ke;return c(),v("div",Fe,[C("",!0),a.value?(c(),v(S,{key:1},[f("div",null,[f("div",Ne,[f("div",Pe,m(e.$t("exactMatch")),1),y(l(D),{conv:U,mode:"multiple",style:{width:"100%"},options:l(p),value:t.value.and_tags,"onUpdate:value":s[0]||(s[0]=u=>t.value.and_tags=u),disabled:!l(p).length,placeholder:e.$t("selectExactMatchTag")},null,8,["options","value","disabled","placeholder"]),a.value.expired||!a.value.img_count?(c(),A(g,{key:0,onClick:l(N),loading:!l(i).isIdle,type:"primary"},{default:O(()=>[I(m(a.value.img_count===0?e.$t("generateIndexHint"):e.$t("UpdateIndex")),1)]),_:1},8,["onClick","loading"])):(c(),A(g,{key:1,type:"primary",onClick:Q,loading:!l(i).isIdle,disabled:!t.value.and_tags.length},{default:O(()=>[I(m(e.$t("search")),1)]),_:1},8,["loading","disabled"]))]),f("div",Ve,[f("div",qe,m(e.$t("anyMatch")),1),y(l(D),{conv:U,mode:"multiple",style:{width:"100%"},options:l(p),value:t.value.or_tags,"onUpdate:value":s[1]||(s[1]=u=>t.value.or_tags=u),disabled:!l(p).length,placeholder:e.$t("selectAnyMatchTag")},null,8,["options","value","disabled","placeholder"])]),f("div",ze,[f("div",Ge,m(e.$t("exclude")),1),y(l(D),{conv:U,mode:"multiple",style:{width:"100%"},options:l(p),value:t.value.not_tags,"onUpdate:value":s[2]||(s[2]=u=>t.value.not_tags=u),disabled:!l(p).length,placeholder:e.$t("selectExcludeTag")},null,8,["options","value","disabled","placeholder"])])]),l(p).filter(u=>u.type!=="custom").length?C("",!0):(c(),v("p",Le,m(e.$t("needGenerateIdx")),1)),f("div",je,[(c(!0),v(S,null,P(l(L),([u,K])=>(c(),v("ul",{class:"tag-list",key:u},[f("h3",Qe,m(e.$t(u)),1),(c(!0),v(S,null,P(K,(_,W)=>(c(),v("li",{key:_.id,class:ue(["tag",{selected:l(E).has(_.id)}]),onClick:X=>J(_)},[l(E).has(_.id)?(c(),A(l(de),{key:0})):C("",!0),I(" "+m(M(_))+" ",1),u==="custom"&&W!==0?(c(),v("span",{key:1,class:"remove",onClickCapture:V(X=>H(_.id),["stop"])},[y(l(ce))],40,He)):C("",!0)],10,Re))),128)),u==="custom"?(c(),v("li",{key:0,class:"tag",onClick:s[4]||(s[4]=_=>w.value=!0)},[w.value?(c(),A(T,{key:0,compact:""},{default:O(()=>[y(h,{value:b.value,"onUpdate:value":s[3]||(s[3]=_=>b.value=_),style:{width:"128px"},loading:l(d),"allow-clear":"",size:"small"},null,8,["value","loading"]),y(k,{size:"small",type:"primary",onClickCapture:V(R,["stop"]),loading:l(d)},{default:O(()=>[I(m(b.value?e.$t("submit"):e.$t("cancel")),1)]),_:1},8,["onClickCapture","loading"])]),_:1})):(c(),v(S,{key:1},[y(l(pe)),I(" "+m(e.$t("add")),1)],64))])):C("",!0)]))),128))])],64)):C("",!0)])}}});const ta=ge(Je,[["__scopeId","data-v-2e24b312"]]);export{ta as default};
